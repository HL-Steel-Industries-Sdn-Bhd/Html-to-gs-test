<!doctype html>
<html lang="zh-Hans">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Task Board — HTML ↔︎ GS</title>
  <style>
    :root{
      --left-width: 20%;
      --right-width: 80%;
      --gap: 12px;
      --card-radius: 10px;
      --cell-size: 120px;
      --font-sans: "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
    }
    *{box-sizing:border-box}
    body{
      font-family:var(--font-sans);
      margin:16px;
      background:#fafafa;
      color:#1f2937;
    }
    .container{
      display:flex;
      gap:var(--gap);
      height:calc(100vh - 40px);
      align-items:flex-start;
    }

    /* 左侧任务区 */
    .left{
      width:var(--left-width);
      min-width:220px;
      background:linear-gradient(180deg,#ffffff,#fbfbff);
      border-radius:12px;
      padding:12px;
      box-shadow:0 6px 18px rgba(11,21,50,0.06);
      overflow:auto;
    }
    .left h2{font-size:16px;margin:6px 0 12px}
    .task-list{display:flex;flex-direction:column;gap:8px}
    .task{
      padding:10px 12px;
      border-radius:10px;
      cursor:grab;
      user-select:none;
      box-shadow:0 2px 6px rgba(10,20,40,0.06);
      min-height:44px;
      display:flex;
      align-items:center;
      gap:8px;
      font-weight:600;
      color:#0b1220;
    }
    .task .meta{font-size:12px;opacity:0.85;font-weight:500}
    .task[data-draggable="false"]{opacity:0.5;cursor:not-allowed}

    /* 右侧调度表 */
    .right{
      width:var(--right-width);
      flex:1;
      background:#fff;
      border-radius:12px;
      padding:14px;
      box-shadow:0 8px 22px rgba(8,18,40,0.06);
      overflow:auto;
    }
    .grid-header{display:flex;align-items:center;gap:8px;margin-bottom:12px}
    .grid{
      display:grid;
      grid-template-columns:150px repeat(3,1fr);
      gap:10px;
      align-items:center;
    }
    .grid .col-title{
      padding:8px 10px;font-weight:700;background:#f6f7fb;border-radius:8px;
      text-align:center;
    }
    .grid .row-title{
      padding:8px 10px;font-weight:700;background:#f6f7fb;border-radius:8px;
    }
    .cell{
      height:var(--cell-size);
      border-radius:8px;
      background:linear-gradient(180deg,#ffffff,#fcfdff);
      border:1px dashed rgba(30,40,80,0.06);
      display:flex;
      align-items:flex-start;
      justify-content:flex-start;
      padding:8px;
      gap:8px;
      overflow:auto;
      flex-direction:column;
    }
    .cell.drop-target{background:#f8fff5;border:2px dashed rgba(30,160,80,0.25)}
    .cell .placed-task{
      padding:6px 8px;border-radius:8px;font-weight:700;cursor:grab;
      display:inline-block;
      margin-bottom:6px;
      box-shadow:0 2px 6px rgba(20,30,50,0.06);
    }

    /* small helper */
    .small{font-size:12px;color:#536179}
    .footer{
      margin-top:12px;font-size:13px;color:#6b7280;display:flex;justify-content:space-between;align-items:center;
    }
    .badge{padding:4px 8px;border-radius:999px;background:#eef2ff;font-weight:700;font-size:13px}
    .btn{
      display:inline-block;padding:8px 12px;border-radius:8px;background:#111827;color:white;font-weight:700;cursor:pointer;
      text-decoration:none;
    }

    /* responsive */
    @media (max-width:900px){
      :root{--left-width:30%}
      .grid{grid-template-columns:120px repeat(3,1fr)}
      .cell{height:100px}
    }
    @media (max-width:600px){
      .container{flex-direction:column}
      .left{width:100%}
      .right{width:100%}
    }
  </style>
</head>
<body>
  <!--
    使用说明（把下列两个 URL 替换成你部署的 GAS Web App URL）：

    1) GET_TASKS_URL: 用来读取 GS2 的任务 (GAS1)
       前端会对该 URL 发 GET 请求，得到 JSON 列表：
       [{ taskId: "row-2", client:"MCD", salesOrder:"SO-009999", itemNo:"1", label:"EXP:MCD (009999-1)"} , ...]

    2) SAVE_ASSIGNMENTS_URL: 用来接收当前页面的编排并写回 GS1 (GAS2)
       前端会每 30 秒将当前 assignments POST 到该 URL，格式为 JSON：
       { sheetId: "...", tabName: "3/11/2025", assignments: [{ rowName:"Albert", time:"9:00", taskId:"row-2", client:"MCD", salesOrder:"SO-009999", itemNo:"1" }, ...] }

    将两个 URL 复制到下方对应变量后即可在 GitHub Pages 直接使用。
  -->
  <div class="container">
    <div class="left" id="left">
      <h2>Task Distribution</h2>
      <div class="small">拉取自 GS2（每次页面加载）</div>
      <div style="height:8px"></div>
      <div class="task-list" id="taskList"></div>
    </div>

    <div class="right">
      <div class="grid-header">
        <div style="flex:1">
          <h3 style="margin:0">Schedule — 3/11/2025</h3>
          <div class="small">拖拽左侧任务到右侧目标格子（代表某人某时间做此任务）</div>
        </div>
        <div>
          <span class="badge" id="lastSaved">未保存</span>
        </div>
      </div>

      <div class="grid" id="grid">
        <!-- grid 会由 JS 动态生成：第一列为姓名，第一行为时间 -->
      </div>

      <div class="footer">
        <div>自动保存间隔：30 秒 · 状态：<span id="status">等待</span></div>
        <div>
          <a id="manualSave" class="btn">立即保存</a>
        </div>
      </div>
    </div>
  </div>

  <script>
    /********************** CONFIG: 替换为你自己部署的 GAS Web App URL **********************/
    const GET_TASKS_URL = "https://script.google.com/macros/s/AKfycbxBoIgtUh1UkDmyrCdLVK_L7su20WNLr0zFSC1ryKeddjEsl65GLFjeNl5hsM0tj0-nNg/exec"; // GET -> 拉取任务 (GAS1)
    const SAVE_ASSIGNMENTS_URL = "https://script.google.com/macros/s/AKfycbyp9syK52XcQT0C1uhqE2F0t_WRrRPO3OarJFOl_1Bobow64nBnU0di_97VLFiXghnusw/exec"; // POST -> 保存编排 (GAS2)
    const GS1_SHEET_ID = "1ReQc_Ob9_tN-EPmQRTugujTGCrnNp5_sN4juZtqA9Mk"; // Html to gs test
    const GS1_TAB_NAME = "3/11/2025";
    /***************************************************************************************/

    // 固定表头数据（你在说明里给的）
    const ROW_NAMES = ["Albert","Bunyau","Cyril"];
    const TIMES = ["9:00","10:00","11:00"];

    // 轻量马卡龙色板（若 sales order 不同则根据 hash 取色）
    const PASTEL_COLORS = [
      "#FFDDE1","#FFE7C7","#FFF7C2","#DFF7D8","#DFF1FF","#EAD7FF",
      "#FDEEF9","#E8F8FF","#FFF0E6","#E8FFE8"
    ];

    // state
    let tasks = []; // {taskId,client,salesOrder,itemNo,label}
    let assignments = {}; // key => `${row}-${time}` value => task object

    // helpers
    function hashStringToIndex(s, mod){
      let h=0;
      for(let i=0;i<s.length;i++){ h=(h<<5)-h + s.charCodeAt(i); h |= 0; }
      return Math.abs(h) % mod;
    }

    // create grid
    function renderGrid(){
      const grid = document.getElementById("grid");
      grid.innerHTML = "";
      // header corner empty
      const corner = document.createElement("div");
      corner.className = "col-title";
      corner.textContent = "";
      grid.appendChild(corner);

      // times header
      for(const t of TIMES){
        const th = document.createElement("div");
        th.className = "col-title";
        th.textContent = t;
        grid.appendChild(th);
      }

      // rows
      for(const r of ROW_NAMES){
        const rowTitle = document.createElement("div");
        rowTitle.className = "row-title";
        rowTitle.textContent = r;
        grid.appendChild(rowTitle);

        for(const t of TIMES){
          const cell = document.createElement("div");
          cell.className = "cell";
          cell.dataset.row = r;
          cell.dataset.time = t;
          cell.dataset.key = `${r}||${t}`;
          cell.addEventListener("dragover", ev => {
            ev.preventDefault();
            cell.classList.add("drop-target");
          });
          cell.addEventListener("dragleave", ev => {
            cell.classList.remove("drop-target");
          });
          cell.addEventListener("drop", ev => {
            ev.preventDefault();
            cell.classList.remove("drop-target");
            const taskId = ev.dataTransfer.getData("text/plain");
            onDropTaskToCell(taskId, cell);
          });

          grid.appendChild(cell);
        }
      }
    }

    function renderTasks(){
      const list = document.getElementById("taskList");
      list.innerHTML = "";
      tasks.forEach(t=>{
        const div = document.createElement("div");
        div.className = "task";
        div.draggable = true;
        div.dataset.taskId = t.taskId;
        div.dataset.salesOrder = t.salesOrder || "";
        div.dataset.client = t.client || "";
        div.dataset.itemNo = t.itemNo || "";
        div.innerHTML = `<div style="flex:1">${t.label}</div><div class="meta">${t.client}</div>`;
        // color by salesOrder
        const idx = hashStringToIndex(t.salesOrder || t.taskId, PASTEL_COLORS.length);
        div.style.background = PASTEL_COLORS[idx];
        div.style.border = "1px solid rgba(0,0,0,0.04)";

        div.addEventListener("dragstart", ev => {
          ev.dataTransfer.setData("text/plain", t.taskId);
        });

        list.appendChild(div);
      });
    }

    function renderAssignments(){
      // clear all cells
      document.querySelectorAll(".cell").forEach(c => c.innerHTML = "");
      for(const key in assignments){
        const entry = assignments[key];
        if(!entry) continue;
        const [row,time] = key.split("||");
        const selector = `.cell[data-row="${row}"][data-time="${time}"]`;
        const cell = document.querySelector(selector);
        if(!cell) continue;
        const el = document.createElement("div");
        el.className = "placed-task";
        el.draggable = true;
        el.dataset.taskId = entry.taskId;
        el.textContent = entry.label;
        // set background colour same as left
        const idx = hashStringToIndex(entry.salesOrder || entry.taskId, PASTEL_COLORS.length);
        el.style.background = PASTEL_COLORS[idx];
        // on dragstart from cell -> support moving task between cells or back to left area
        el.addEventListener("dragstart", ev => {
          ev.dataTransfer.setData("text/plain", entry.taskId);
          // mark source so drop handler knows to remove from previous cell if moved
          ev.dataTransfer.setData("fromCell", key);
        });
        // double click to remove
        el.addEventListener("dblclick", () => {
          delete assignments[key];
          renderAssignments();
        });
        cell.appendChild(el);
      }
    }

    function onDropTaskToCell(taskId, cell){
      const row = cell.dataset.row;
      const time = cell.dataset.time;
      const key = `${row}||${time}`;
      const taskObj = tasks.find(x=>x.taskId===taskId);
      if(!taskObj){
        // maybe it's already placed — find its original data from assignments
        // find assignments value with that taskId
        for(const k in assignments){
          if(assignments[k] && assignments[k].taskId === taskId){
            // move
            const moving = assignments[k];
            delete assignments[k];
            assignments[key] = moving;
            renderAssignments();
            markDirty();
            return;
          }
        }
        return;
      }
      // If this cell already has a task, replace it (覆盖)
      assignments[key] = {
        taskId: taskObj.taskId,
        client: taskObj.client,
        salesOrder: taskObj.salesOrder,
        itemNo: taskObj.itemNo,
        label: taskObj.label
      };
      renderAssignments();
      markDirty();
    }

    // allow dragging placed tasks back to left panel to "unassign"
    function enableReturnToLeft(){
      const left = document.getElementById("left");
      left.addEventListener("dragover", ev => ev.preventDefault());
      left.addEventListener("drop", ev => {
        ev.preventDefault();
        const taskId = ev.dataTransfer.getData("text/plain");
        const fromKey = ev.dataTransfer.getData("fromCell");
        if(fromKey){
          delete assignments[fromKey];
          renderAssignments();
          markDirty();
        }
      });
    }

    // state save / polling
    let saveTimer = null;
    let dirty = false;
    function markDirty(){
      dirty = true;
      document.getElementById("status").textContent = "已修改（等待自动保存）";
    }

    async function saveAssignments(manual=false){
      const arr = [];
      for(const key in assignments){
        const val = assignments[key];
        if(!val) continue;
        const [row,time] = key.split("||");
        arr.push({
          rowName: row,
          time: time,
          taskId: val.taskId,
          client: val.client,
          salesOrder: val.salesOrder,
          itemNo: val.itemNo
        });
      }
      const payload = {
        sheetId: GS1_SHEET_ID,
        tabName: "3/11/2025",
        assignments: arr
      };
      document.getElementById("status").textContent = "保存中...";
      try{
        const res = await fetch(SAVE_ASSIGNMENTS_URL, {
          method: "POST",
          headers: {'Content-Type':'application/json'},
          body: JSON.stringify(payload)
        });
        const j = await res.json();
        // 期望 GAS 返回 { success: true, message: "...", timestamp: "..." }
        if(j && j.success){
          document.getElementById("lastSaved").textContent = "上次保存: " + (j.timestamp || new Date().toLocaleTimeString());
          document.getElementById("status").textContent = "已保存";
          dirty = false;
          if(manual){
            flashSaved();
          }
        } else {
          document.getElementById("status").textContent = "保存失败";
          console.error("save failed", j);
        }
      }catch(err){
        document.getElementById("status").textContent = "保存出错";
        console.error(err);
      }
    }

    function flashSaved(){
      const el = document.getElementById("lastSaved");
      el.style.transition = "transform 150ms";
      el.style.transform = "scale(1.05)";
      setTimeout(()=>el.style.transform="",200);
    }

    // auto poll every 30s to save if dirty
    function startAutoSave(){
      if(saveTimer) clearInterval(saveTimer);
      saveTimer = setInterval(()=>{
        if(dirty) saveAssignments(false);
      }, 30_000);
    }

    // manual save button
    document.getElementById("manualSave").addEventListener("click", ()=> saveAssignments(true));

    // 获取任务（从 GAS1）
    async function fetchTasks(){
      try{
        // we expect the GAS to accept sheetId & tab as query params but GAS1 can also hardcode
        const url = new URL(GET_TASKS_URL);
        url.searchParams.set("sheetId","1qHXrnXiL29CuikWOjWtuEwjlPEEOW21TY7-27ToF8VU");
        url.searchParams.set("tab","Client Name-Sales Order-Item No.");
        const res = await fetch(url.toString(), { cache: "no-store" });
        const j = await res.json();
        // assume j.tasks = [{taskId,client,salesOrder,itemNo,label}, ...]
        if(Array.isArray(j.tasks)) {
          tasks = j.tasks;
        } else if (Array.isArray(j)) {
          tasks = j;
        } else {
          tasks = [];
        }
      }catch(err){
        console.error("fetchTasks error", err);
        tasks = [];
      }
      renderTasks();
    }

    // load initial state
    (function init(){
      renderGrid();
      enableReturnToLeft();
      fetchTasks();
      renderAssignments();
      startAutoSave();
      // auto save even if not dirty every 5 minutes as fallback
      setInterval(()=>{ if(!dirty) saveAssignments(false); }, 5*60*1000);
    })();

    // expose for debugging
    window.__TB = {
      renderGrid,renderTasks,renderAssignments,fetchTasks,assignments
    };
  </script>
</body>
</html>
